!function(){"use strict";var t,e;!function(t){const{getOwnPropertyDescriptor:e,defineProperty:s}=Object;function i(t,e,s){const i=t[e];if(!i)return!1;const n=s(i);return t[e]=n,!0}t.func=i,t.prop=function(t,n,a,r){const o=e(t,n);return!!o&&(a&&i(o,"get",a),r&&i(o,"set",r),s(t,n,o),!0)}}(t||(t={})),function(t){let e,s,i,n=0;function a(){return-1!==document.cookie.indexOf("freecdn=0")}function r(){var t;document.cookie="freecdn=0; path=/; max-age=600",s&&(a()?location.reload():(t="This site requires cookies to be enabled",document.documentElement.innerHTML=t))}function o(){const{controller:t}=e;t?(clearInterval(i),location.reload()):30==++n&&(console.warn("[freecdn] service worker install timeout"),clearInterval(i),r())}if(self.document)try{!function(){if(a())return;const t=document.getElementsByTagName("noscript")[0];if(t&&t.innerHTML.indexOf("/freecdn-nojs")>0&&(s=!0),e=navigator.serviceWorker,!e)return console.warn("[freecdn] service worker disabled"),void r();i=setInterval(o,100)}()}catch(t){console.error(t),r()}}(e||(e={}));const s=new Uint8Array(0),i=new Map,n=location.origin,a=crypto.subtle;let r;function o(){let t,e;const s=new Promise(((s,i)=>{t=s,e=i}));return s.resolve=t,s.reject=e,s}var c;!function(t){const e=new TextEncoder,s=new TextDecoder;function i(t){return t.reduce(((t,e)=>t+String.fromCharCode(e)),"")}t.utf8ToBytes=function(t){return e.encode(t)},t.bytesToUtf8=function(t){return s.decode(t)},t.bytesToAsc=i,t.base64Encode=function(t){return btoa(i(t))},t.base64Decode=function(t){const e=atob(t),s=new Uint8Array(e.length);for(let t=0;t<s.length;t++)s[t]=e.charCodeAt(t);return s},t.parseStrOrB64=function(e){if('"'===e[0]){try{e=JSON.parse(e)}catch{return null}return t.utf8ToBytes(e)}try{return t.base64Decode(e)}catch{return null}};const r={"":1,ms:1,s:1e3,min:6e4,h:36e5,d:864e5,y:31536e6};t.parseTime=function(t){const e=t.match(/^([\d.]{1,9})(y|d|h|min|s|ms|)$/);if(!e)return NaN;const[,s,i]=e;return+s*r[i]},t.parseByteUnit=function(t){const e=t.match(/^([\d.]{1,9})(k|M|G|T|)(i|)(b|B|)$/);if(!e)return NaN;const[,s,i,n,a]=e;return+s*(n?1024:1e3)**("k"===i?1:"M"===i?2:"G"===i?3:"T"===i?4:0)/("b"===a?8:1)},t.getTimeSec=function(){return Date.now()/1e3|0},t.concatBufs=function(t,e=0){if(0===e)for(const s of t)e+=s.length;const s=new Uint8Array(e);let i=0;for(const e of t)s.set(e,i),i+=e.length;return s},t.isArrayEqual=function(t,e){if(t.length!==e.length)return!1;for(let s=0;s<t.length;s++)if(t[s]!==e[s])return!1;return!0},t.swap=function(t,e,s){const i=t[e];t[e]=t[s],t[s]=i},t.rand=function(){return 4294967295*Math.random()>>>0},t.getKvPair=function(t,e){const s=t.indexOf(e);return-1===s?[t,null]:[t.substr(0,s),t.substr(s+e.length)]},t.mergeMap=function(t,e){for(const[s,i]of e)t.set(s,i)},t.getHostFromUrl=function(t){const e=t.match(/^https?:\/\/([^/]+)/);return e&&e[1]},t.toAbsUrl=function(t){return"/"===t[0]?n+t:t},t.sha256=async function(t){const e=await a.digest("SHA-256",t);return new Uint8Array(e)}}(c||(c={}));class l extends Error{constructor(t){super(t)}}class p{onRequest(t,e){}onResponse(t,e,s){}onData(t){return t}onEnd(t){return t}onError(t){}onAbort(t,e){}}class m extends p{constructor(t){super(),this.headers=t}static parse(t,e){const s=[];if("{"===t[0]){let i;try{i=JSON.parse(t)}catch{return void console.warn(`[${e}] invalid json: ${t}`)}for(const[t,n]of Object.entries(i)){if("string"!=typeof n)return void console.warn(`[${e}] invalid type: ${t} ${n}`);s.push([t,n])}}else{const[i,n]=c.getKvPair(t,":");if(!n)return void console.warn(`[${e}] invalid value: ${i}`);s.push([i,n])}return[s]}static parseConf(t){return this.parse(t,"add-req-header")}onRequest(t){for(const[e,s]of this.headers)t.headers.append(e,s)}}class u extends p{constructor(t){super(),this.mime=t}static createExtMimeMap(){const t=new Map;for(const e of"application/andrew-inset:ez;application/applixware:aw;application/atom+xml:atom;application/atomcat+xml:atomcat;application/atomdeleted+xml:atomdeleted;application/atomsvc+xml:atomsvc;application/atsc-dwd+xml:dwd;application/atsc-held+xml:held;application/atsc-rsat+xml:rsat;application/bdoc:bdoc;application/calendar+xml:xcs;application/ccxml+xml:ccxml;application/cdfx+xml:cdfx;application/cdmi-capability:cdmia;application/cdmi-container:cdmic;application/cdmi-domain:cdmid;application/cdmi-object:cdmio;application/cdmi-queue:cdmiq;application/cu-seeme:cu;application/dash+xml:mpd;application/davmount+xml:davmount;application/docbook+xml:dbk;application/dssc+der:dssc;application/dssc+xml:xdssc;application/ecmascript:ecma,es;application/emma+xml:emma;application/emotionml+xml:emotionml;application/epub+zip:epub;application/exi:exi;application/fdt+xml:fdt;application/font-tdpfr:pfr;application/geo+json:geojson;application/gml+xml:gml;application/gpx+xml:gpx;application/gxf:gxf;application/gzip:gz;application/hjson:hjson;application/hyperstudio:stk;application/inkml+xml:ink,inkml;application/ipfix:ipfix;application/its+xml:its;application/java-archive:jar,war,ear;application/java-serialized-object:ser;application/java-vm:class;application/javascript:js,mjs;application/json:json,map;application/json5:json5;application/jsonml+json:jsonml;application/ld+json:jsonld;application/lgr+xml:lgr;application/lost+xml:lostxml;application/mac-binhex40:hqx;application/mac-compactpro:cpt;application/mads+xml:mads;application/manifest+json:webmanifest;application/marc:mrc;application/marcxml+xml:mrcx;application/mathematica:ma,nb,mb;application/mathml+xml:mathml;application/mbox:mbox;application/mediaservercontrol+xml:mscml;application/metalink+xml:metalink;application/metalink4+xml:meta4;application/mets+xml:mets;application/mmt-aei+xml:maei;application/mmt-usd+xml:musd;application/mods+xml:mods;application/mp21:m21,mp21;application/mp4:mp4s,m4p;application/mrb-consumer+xml:xdf;application/mrb-publish+xml:xdf;application/msword:doc,dot;application/mxf:mxf;application/n-quads:nq;application/n-triples:nt;application/node:cjs;application/octet-stream:bin,dms,lrf,mar,so,dist,distz,pkg,bpk,dump,elc,deploy,exe,dll,deb,dmg,iso,img,msi,msp,msm,buffer;application/oda:oda;application/oebps-package+xml:opf;application/ogg:ogx;application/omdoc+xml:omdoc;application/onenote:onetoc,onetoc2,onetmp,onepkg;application/oxps:oxps;application/p2p-overlay+xml:relo;application/patch-ops-error+xml:xer;application/pdf:pdf;application/pgp-encrypted:pgp;application/pgp-signature:asc,sig;application/pics-rules:prf;application/pkcs10:p10;application/pkcs7-mime:p7m,p7c;application/pkcs7-signature:p7s;application/pkcs8:p8;application/pkix-attr-cert:ac;application/pkix-cert:cer;application/pkix-crl:crl;application/pkix-pkipath:pkipath;application/pkixcmp:pki;application/pls+xml:pls;application/postscript:ai,eps,ps;application/provenance+xml:provx;application/pskc+xml:pskcxml;application/raml+yaml:raml;application/rdf+xml:rdf,owl;application/reginfo+xml:rif;application/relax-ng-compact-syntax:rnc;application/resource-lists+xml:rl;application/resource-lists-diff+xml:rld;application/rls-services+xml:rs;application/route-apd+xml:rapd;application/route-s-tsid+xml:sls;application/route-usd+xml:rusd;application/rpki-ghostbusters:gbr;application/rpki-manifest:mft;application/rpki-roa:roa;application/rsd+xml:rsd;application/rss+xml:rss;application/rtf:rtf;application/sbml+xml:sbml;application/scvp-cv-request:scq;application/scvp-cv-response:scs;application/scvp-vp-request:spq;application/scvp-vp-response:spp;application/sdp:sdp;application/senml+xml:senmlx;application/sensml+xml:sensmlx;application/set-payment-initiation:setpay;application/set-registration-initiation:setreg;application/shf+xml:shf;application/sieve:siv,sieve;application/smil+xml:smi,smil;application/sparql-query:rq;application/sparql-results+xml:srx;application/srgs:gram;application/srgs+xml:grxml;application/sru+xml:sru;application/ssdl+xml:ssdl;application/ssml+xml:ssml;application/swid+xml:swidtag;application/tei+xml:tei,teicorpus;application/thraud+xml:tfi;application/timestamped-data:tsd;application/toml:toml;application/ttml+xml:ttml;application/ubjson:ubj;application/urc-ressheet+xml:rsheet;application/urc-targetdesc+xml:td;application/voicexml+xml:vxml;application/wasm:wasm;application/widget:wgt;application/winhlp:hlp;application/wsdl+xml:wsdl;application/wspolicy+xml:wspolicy;application/xaml+xml:xaml;application/xcap-att+xml:xav;application/xcap-caps+xml:xca;application/xcap-diff+xml:xdf;application/xcap-el+xml:xel;application/xcap-error+xml:xer;application/xcap-ns+xml:xns;application/xenc+xml:xenc;application/xhtml+xml:xhtml,xht;application/xliff+xml:xlf;application/xml:xml,xsl,xsd,rng;application/xml-dtd:dtd;application/xop+xml:xop;application/xproc+xml:xpl;application/xslt+xml:xsl,xslt;application/xspf+xml:xspf;application/xv+xml:mxml,xhvml,xvml,xvm;application/yang:yang;application/yin+xml:yin;application/zip:zip;audio/3gpp:3gpp;audio/adpcm:adp;audio/basic:au,snd;audio/midi:mid,midi,kar,rmi;audio/mobile-xmf:mxmf;audio/mp3:mp3;audio/mp4:m4a,mp4a;audio/mpeg:mpga,mp2,mp2a,mp3,m2a,m3a;audio/ogg:oga,ogg,spx;audio/s3m:s3m;audio/silk:sil;audio/wav:wav;audio/wave:wav;audio/webm:weba;audio/xm:xm;font/collection:ttc;font/otf:otf;font/ttf:ttf;font/woff:woff;font/woff2:woff2;image/aces:exr;image/apng:apng;image/avif:avif;image/bmp:bmp;image/cgm:cgm;image/dicom-rle:drle;image/emf:emf;image/fits:fits;image/g3fax:g3;image/gif:gif;image/heic:heic;image/heic-sequence:heics;image/heif:heif;image/heif-sequence:heifs;image/hej2k:hej2;image/hsj2:hsj2;image/ief:ief;image/jls:jls;image/jp2:jp2,jpg2;image/jpeg:jpeg,jpg,jpe;image/jph:jph;image/jphc:jhc;image/jpm:jpm;image/jpx:jpx,jpf;image/jxr:jxr;image/jxra:jxra;image/jxrs:jxrs;image/jxs:jxs;image/jxsc:jxsc;image/jxsi:jxsi;image/jxss:jxss;image/ktx:ktx;image/ktx2:ktx2;image/png:png;image/sgi:sgi;image/svg+xml:svg,svgz;image/t38:t38;image/tiff:tif,tiff;image/tiff-fx:tfx;image/webp:webp;image/wmf:wmf;message/disposition-notification:disposition-notification;message/global:u8msg;message/global-delivery-status:u8dsn;message/global-disposition-notification:u8mdn;message/global-headers:u8hdr;message/rfc822:eml,mime;model/3mf:3mf;model/gltf+json:gltf;model/gltf-binary:glb;model/iges:igs,iges;model/mesh:msh,mesh,silo;model/mtl:mtl;model/obj:obj;model/stl:stl;model/vrml:wrl,vrml;model/x3d+binary:x3db,x3dbz;model/x3d+fastinfoset:x3db;model/x3d+vrml:x3dv,x3dvz;model/x3d+xml:x3d,x3dz;model/x3d-vrml:x3dv;text/cache-manifest:appcache,manifest;text/calendar:ics,ifb;text/coffeescript:coffee,litcoffee;text/css:css;text/csv:csv;text/html:html,htm,shtml;text/jade:jade;text/jsx:jsx;text/less:less;text/markdown:markdown,md;text/mathml:mml;text/mdx:mdx;text/n3:n3;text/plain:txt,text,conf,def,list,log,in,ini;text/richtext:rtx;text/rtf:rtf;text/sgml:sgml,sgm;text/shex:shex;text/slim:slim,slm;text/spdx:spdx;text/stylus:stylus,styl;text/tab-separated-values:tsv;text/troff:t,tr,roff,man,me,ms;text/turtle:ttl;text/uri-list:uri,uris,urls;text/vcard:vcard;text/vtt:vtt;text/xml:xml;text/yaml:yaml,yml;video/3gpp:3gp,3gpp;video/3gpp2:3g2;video/h261:h261;video/h263:h263;video/h264:h264;video/jpeg:jpgv;video/jpm:jpm,jpgm;video/mj2:mj2,mjp2;video/mp2t:ts;video/mp4:mp4,mp4v,mpg4;video/mpeg:mpeg,mpg,mpe,m1v,m2v;video/ogg:ogv;video/quicktime:qt,mov;video/webm:webm".split(";")){const[s,i]=e.split(":");for(const e of i.split(","))t.set(e,s)}return t}static parseConf(t){return this.extMimeMap||(this.extMimeMap=this.createExtMimeMap()),[t]}onResponse(t,e){let s;if("auto"===this.mime){const t=e.rawReq.url.match(/\.(\w+)(?:$|\?)/);if(t){const e=t[1].toLowerCase();s=u.extMimeMap.get(e)}s||(s="application/octet-stream")}else s=this.mime;t.headers.set("content-type",s)}}class h extends p{constructor(){super(),this.state=0}static async init(){this.signal=o();const t=new g;await t.parse("/freecdn-internal/br/br.wasm\n http://127.0.0.1:20000/freecdn-internal/br/br.wasm\n https://cdn.jsdelivr.net/gh/etherdream/freecdn/freecdn@0.0.1/tool/assets/js/freecdn-internal/br/br.wasm\n https://unpkg.com/freecdn@0.0.1/browser/dist/br/br.wasm\n #hash=w7Zbum/oD8CzP5UKtRDW8+0bmoFIHs06PfiGF42t0uw=\n\n/freecdn-internal/br/br.min.js\n http://127.0.0.1:20000/freecdn-internal/br/br.min.js\n https://cdn.jsdelivr.net/gh/etherdream/freecdn/freecdn@0.0.1/tool/assets/js/freecdn-internal/br/br.min.js\n https://unpkg.com/freecdn@0.0.1/browser/dist/br/br.min.js\n #hash=w7Zbum/oD8CzP5UKtRDW8+0bmoFIHs06PfiGF42t0uw=\n");const e=new E;e.manifest=t;const s=await e.fetchText("/freecdn-internal/br/br.min.js"),i=e.fetch.bind(e),n={locateFile:()=>"/freecdn-internal/br/br.wasm"};Function("Module","fetch",s)(n,i),n.onRuntimeInitialized=()=>{this.inPtr=n._AllocInBuf(131072),this.outPtr=n._AllocOutBuf(524288),this.signal?.resolve(),this.signal=null},this.asmMod=n}static parseConf(t){if("off"!==t)return"on"===t?(this.asmMod||this.signal||this.init(),[]):"invalid value"}onData(t){return h.signal?this.pending(t):this.process(t)}onEnd(t){let e=s;return t.length>0&&(e=this.process(t)),this.destory(),e}async pending(t){return await h.signal,this.process(t)}process(t){const e=h.asmMod,s=e.HEAPU8;0===this.state&&(this.state=e._Init());const i=[];for(let n=0;n<t.length;n+=131072){const a=t.subarray(n,n+131072);s.set(a,h.inPtr);let r=0,o=a.length,c=0;do{if(0===e._Update(this.state,r,o)){const t=e._GetErrorCode();this.destory();debugger;throw new l("br decode error: "+t)}o=e._GetAvailableIn(),c=e._GetAvailableOut();const t=524288-c;if(0===t)continue;const n=s.slice(h.outPtr,h.outPtr+t);i.push(n)}while(e._HasMoreOutput(this.state))}return 1===i.length?i[0]:c.concatBufs(i)}destory(){h.asmMod._Destroy(this.state)}}const d={open_timeout:class extends p{constructor(t){super(),this.time=t,this.tid=0}static parseConf(t){const e=c.parseTime(t);return isNaN(e)?"invalid time format":[e]}onRequest(t,e){this.tid=setTimeout((()=>{e.loadNextUrl()}),this.time)}onResponse(){this.stopTimer()}onError(){this.stopTimer()}onAbort(){this.stopTimer()}stopTimer(){this.tid>0&&(clearTimeout(this.tid),this.tid=0)}},recv_timeout:class extends p{constructor(t,e){super(),this.bytes=t,this.time=e,this.tid=0,this.sum=0}static parseConf(t){const[e,s]=t.split("/"),i=c.parseByteUnit(e),n=c.parseTime(s);return isNaN(i)?"invalid byte format":isNaN(n)?"invalid time format":[i,n]}onRequest(t,e){this.fileLoader=e}onResponse(){this.tid=setInterval((()=>{this.sum<=this.bytes&&(this.stopTimer(),this.fileLoader.loadNextUrl()),this.sum=0}),this.time)}onData(t){return this.sum+=t.length,t}async onEnd(t){return this.stopTimer(),t}onError(){this.stopTimer()}onAbort(){this.stopTimer()}stopTimer(){this.tid>0&&(clearTimeout(this.tid),this.tid=0)}},credentials:class extends p{constructor(t){super(),this.enable=t}static parseConf(t){return"on"===t?[!0]:"off"===t?[!1]:"invaild value"}onRequest(t){t.credentials=this.enable?"include":"omit"}},referrer:class extends p{constructor(t){super(),this.policy=t}static parseConf(t){switch(t){case"default":return;case"no":return["no-referrer"];case"full":return["unsafe-url"];case"origin":return["origin"]}return"invalid value"}onRequest(t){t.referrerPolicy=this.policy}},keep_req_header:class extends p{constructor(t){super(),this.keys=t}static parseConf(t){return[t.split(",")]}onRequest(t,e){for(const s of this.keys){const i=e.rawReq.headers.get(s);i&&t.headers.set(s,i)}}},add_req_header:m,keep_res_header:class extends p{constructor(t){super(),this.keys=t}static parseConf(t){return[t.split(",")]}onResponse(t,e,s){for(const e of this.keys){const i=s.headers.get(e);i&&t.headers.set(e,i)}}},expires:class extends p{constructor(t){super(),this.seconds=t}static parseConf(t){const e=c.parseTime(t)/1e3|0;return isNaN(e)?"invalid time format":[e]}onResponse(t){t.headers.append("cache-control","max-age="+this.seconds)}},mime:u,add_res_header:class extends p{constructor(t){super(),this.headers=t}static parseConf(t){return m.parse(t,"add-res-header")}onResponse(t){for(const[e,s]of this.headers)t.headers.append(e,s)}},prefix:class extends p{constructor(t){super(),this.bytes=t,this.done=!1}static parseConf(t){const e=c.parseStrOrB64(t);return e?[e]:"invalid format"}onData(t){return this.done?t:(this.done=!0,c.concatBufs([this.bytes,t]))}onEnd(t){return this.onData(t)}},suffix:class extends p{constructor(t){super(),this.bytes=t}static parseConf(t){const e=c.parseStrOrB64(t);return e?[e]:"invalid format"}onEnd(t){return 0===t.length?this.bytes:c.concatBufs([t,this.bytes])}},seek:class extends p{constructor(t){super(),this.done=!1,this.remain=t}static parseConf(t){const e=c.parseByteUnit(t);return e<=0?"invalid bytes format":[e]}onData(t){if(this.done)return t;const e=this.remain-=t.length;return e>0?s:(this.done=!0,0===e?s:t.subarray(e))}onEnd(t){return this.onData(t)}},size:class extends p{constructor(t){super(),this.size=t,this.done=!1,this.remain=t}static parseConf(t){const e=c.parseByteUnit(t);return e<=0?"invalid bytes format":[e]}onData(t){if(this.done)return s;const e=this.remain-=t.length;return e>0?t:(this.done=!0,0===e?t:t.subarray(0,e))}onEnd(t){return this.onData(t)}},br:h,xor:class extends p{constructor(t){super(),this.key=t}static parseConf(t){const e=0|+t;return e<0||e>255?"invalid value":[e]}onData(t){for(let e=0;e<t.length;e++)t[e]^=this.key;return t}onEnd(t){return this.onData(t)}},hash:class extends p{constructor(t,e){super(),this.blkLen=t,this.hashArr=e,this.queueArr=[],this.queueLen=0}static parseConf(t){let e=1/0,s=t;const i=t.indexOf(";");if(i>0){const n=t.substr(0,i);if(s=t.substr(i+1),e=c.parseByteUnit(n),isNaN(e))return"invalid block length"}try{return[e,s.split(",").map(c.base64Decode).reverse()]}catch{return"invalid base64 format"}}async onData(t){if(this.queueLen+=t.length,this.queueLen>=this.blkLen){const e=this.queueLen%this.blkLen;if(e){const s=t.subarray(0,-e);this.queueArr.push(s)}else this.queueArr.push(t);const s=await this.pull();if(this.queueLen=e,e){const s=t.subarray(-e);this.queueArr.push(s)}return s}if(this.queueArr.push(t),this.queueLen>67108864)throw new l("max queue length exceeded");return s}onEnd(t){return t.length>0&&(this.queueLen+=t.length,this.queueArr.push(t)),0===this.queueLen?s:this.pull()}async pull(){const t=c.concatBufs(this.queueArr,this.queueLen);this.queueArr.length=0;for(let e=0;e<t.length;e+=this.blkLen){const s=t.subarray(e,e+this.blkLen),i=this.hashArr.pop();if(!i)throw new l("missing hash");const n=await c.sha256(s);if(!c.isArrayEqual(i,n)){const t=c.base64Encode(i),e=c.base64Encode(n);throw new l("hash incorrect! expected: "+t+", but got: "+e)}}return t}}};Object.values(d).forEach(((t,e)=>{t.priority=e}));class f{constructor(t,e){this.fileParams=e,[this.url,this.frag]=c.getKvPair(t,"#")}parse(t){const e=new Map;c.mergeMap(e,t.globalParams);const s=this.getHostParams(t);if(s&&c.mergeMap(e,s),c.mergeMap(e,this.fileParams),this.frag){const t=new URLSearchParams(this.frag);c.mergeMap(e,t)}const i=[];for(const[t,s]of e){const e=d[t];if(!e){console.warn("unknown param:",t);continue}const n=e.parseConf(s);if(void 0===n)continue;if("string"==typeof n){console.warn("parseConf failed. mod:",t,"err:",n,"conf:",s);continue}const a=new e(...n);i.push(a)}return i.sort(((t,e)=>t.constructor.priority-e.constructor.priority)),i}getHostParams(t){const e=c.getHostFromUrl(this.url)||"",s=t.getFileParams("host "+e);if(s)return s;let i=0;for(;;){const s=e.substr(i),n=s.indexOf(".");if(-1===n)break;const a=t.getFileParams("host ."+s);if(a)return a;i+=n+1}return null}}class x{constructor(t,e){this.name=t,this.lines=e}getLines(){return this.lines}parse(){if(this.lines){const t=[],e=new Map;for(const s of this.lines)if(/^https?:|^\//.test(s)){const i=c.toAbsUrl(s),n=new f(i,e);t.push(n)}else{const[t,i]=c.getKvPair(s,"=");e.set(t,i)}this.lines=null,this.params=e,this.urlConfs=t}return{urlConfs:this.urlConfs,params:this.params}}}class g{constructor(){this.urlFileMap=new Map}exist(t){return this.urlFileMap.has(c.toAbsUrl(t))}get(t){return this.urlFileMap.get(t)}getFileParams(t){const e=this.urlFileMap.get("@"+t);if(e){const{params:t}=e.parse();return t}return null}async parse(t){this.parseFile(t+"\n@__default__\n expires=30s\n mime=auto\n open_timeout=2s\n");const e=this.get("@include");if(e){const t=new E;t.manifest=this;const s=e.getLines();(await Promise.all(s.map(t.fetchText,t))).forEach(this.parseFile,this)}return!0}parseFile(t){let e="",s=[];const i=()=>{const t=new x(e,s);this.urlFileMap.set(e,t)};for(const n of t.split("\n")){const t=n.trim();if(t&&"#"!==t[0])if(/^\s/.test(n)){if(!e)return void console.warn("missing filename");s.push(t)}else e&&(i(),s=[]),e=c.toAbsUrl(t)}i();const n=this.getFileParams("__default__"),a=this.getFileParams("global");if(n)this.globalParams=a?new Map([...n,...a]):n;else debugger}}class w{constructor(t){this.name=t}open(t){const e=o(),s=indexedDB.open(this.name);return s.onsuccess=()=>{const i=s.result;this.db=i,i.onclose=()=>{console.warn("indexedDB disconnected, reopen..."),this.open(t)},e.resolve()},s.onerror=t=>{console.warn("indexedDB open error:",t),e.reject(s.error)},s.onupgradeneeded=()=>{const e=s.result;for(const[s,i]of Object.entries(t))e.createObjectStore(s,i)},e}close(){this.db.close()}get(t,e){const s=o(),i=this.getStore(t,"readonly").get(e);return i.onsuccess=()=>{s.resolve(i.result)},i.onerror=()=>{s.reject(i.error)},s}put(t,e){const s=o(),i=this.getStore(t,"readwrite").put(e);return i.onsuccess=()=>{s.resolve()},i.onerror=()=>{s.reject(i.error)},s}delete(t,e){const s=o(),i=this.getStore(t,"readwrite").delete(e);return i.onsuccess=()=>{s.resolve()},i.onerror=()=>{s.reject(i.error)},s}enum(t,e,...s){const i=o(),n=this.getStore(t,"readonly").openCursor(...s);return n.onsuccess=()=>{const{result:t}=n;if(!t)return void i.resolve();!1!==e(t.value)&&t.continue()},n.onerror=()=>{i.reject(n.error)},i}getStore(t,e){return this.db.transaction(t,e).objectStore(t)}}var b,y;!function(t){const e=new Map;function s(){return caches.open(".freecdn")}t.addLoadedUrl=async function(t,s){if(e.has(t))return;const i=c.getTimeSec()+s;e.set(t,i);const n={url:t,expire:i};await r.put("cache",n)},t.getExpire=function(t){return e.get(t)},t.init=async function(){const t=c.getTimeSec();await r.enum("cache",(s=>{s.expire<t?r.delete("cache",s.url):e.set(s.url,s.expire)}))},t.findCache=async function(t){const e=await s();return await e.match(t)},t.addCache=async function(t,e){const i=await s();try{await i.put(t,e)}catch{}}}(b||(b={})),function(t){let e;t.set=async function(t){const s=c.base64Decode(t);e=await a.importKey("spki",s,{name:"ECDSA",namedCurve:"P-256"},!1,["verify"])},t.verify=async function(t,s){return!!e&&await a.verify({name:"ECDSA",hash:{name:"SHA-256"}},e,s,t)},t.update=async function(){}}(y||(y={}));const v=fetch;class j{constructor(){this.lastRecordNum=0}async fetch(t,e=!1){let s;e&&(s={mode:"same-origin",cache:"only-if-cached"});const i=await v(t,s),n=this.parseCacheAge(i.headers);return n>60&&b.addLoadedUrl(i.url,n),i}parseCacheAge(t){const e=t.get("cache-control");if(e){if(/no-cache/i.test(e))return 0;const t=e.match(/(?:^|,\s*)max-age="?(\d+)"?/i);if(t)return+t[1]}const s=t.get("expires");if(!s)return-1;const i=Date.parse(s);if(isNaN(i))return-1;const n=t.get("date"),a=n?Date.parse(n):Date.now();return isNaN(a)?-1:(i-a)/1e3|0}statistic(){const t=performance.getEntriesByType("resource"),e=t.length;if(e===this.lastRecordNum)return;const s=performance.timeOrigin;for(let s=this.lastRecordNum;s<e;s++){const e=t[s];e.name,e.startTime,e.domainLookupEnd,e.domainLookupStart,e.connectEnd,e.connectStart,e.transferSize}this.lastRecordNum=e}}class k{constructor(t,e){this.freecdn=e,this.abortCtrl=new AbortController,this.isNetErr=!1,this.isDone=!1,this.isAborted=!1,this.bytesRead=0,this.url=t.url,this.mods=t.parse(e.manifest)}async request(t){let e;try{e=await this.requestImpl(t)}catch(t){console.assert(t instanceof l),e=t}if(!this.isAborted&&e){for(const t of this.mods)t.onError(e);this.onError(e),this.isNetErr||this.abort(e,!0)}}async requestImpl(t){const{rawReq:e}=t,i={headers:new Headers,referrerPolicy:e.referrerPolicy};for(const e of this.mods)e.onRequest(i,t);i.signal=this.abortCtrl.signal;const n=new Request(this.url,i);let a;try{a=await this.freecdn.network.fetch(n)}catch(t){return this.isNetErr=!0,t}const{status:r}=a;if(200!==r)return new Error("http status: "+r);const o={status:a.status,statusText:a.statusText,headers:new Headers};for(const e of this.mods)e.onResponse(o,t,a);if(this.onResponse(o),!a.body){debugger;return new Error("missing body")}const c=a.body.getReader();let l;t:for(;;){try{const{done:t,value:e}=await c.read();if(!e){console.assert(t);break t}l=e}catch(t){return this.isNetErr=!0,t}for(const t of this.mods){const e=t.onData(l);if(l=e instanceof Promise?await e:e,0===l.length)continue t}l.length>0&&(this.pauseSignal&&await this.pauseSignal,this.bytesRead+=l.length,this.onData(l))}this.isDone=!0,l=s;for(const t of this.mods){const e=t.onEnd(l);l=e instanceof Promise?await e:e}l.length>0&&(this.pauseSignal&&await this.pauseSignal,this.bytesRead+=l.length,this.onData(l)),this.onEnd()}pause(){console.assert(!this.pauseSignal),this.pauseSignal=o()}resume(){this.pauseSignal&&(this.pauseSignal.resolve(),this.pauseSignal=null)}abort(t,e){if(!this.isDone){this.isAborted=!0,this.abortCtrl.abort();for(const s of this.mods)s.onAbort(t,e)}}}class C{constructor(t,e,s,n){this.rawReq=s,this.freecdn=n,this.urlLoaderSet=new Set,this.opened=!1,this.closed=!1,this.bytesRead=0;const a=new f(t,i);this.urlConfs=e.concat(a).reverse()}open(){this.loadNextUrl()}pause(){for(const t of this.urlLoaderSet)t.pause()}resume(){for(const t of this.urlLoaderSet)t.resume()}abort(t){for(const e of this.urlLoaderSet)e.abort(t,!1)}getBestUrlConf(){const{urlConfs:t}=this;let e=-1,s=0;return t.forEach(((t,i)=>{const n=b.getExpire(t.url);n&&n>s&&(s=n,e=i)})),e>=0&&c.swap(t,e,t.length-1),t.pop()}loadNextUrl(){const t=this.getBestUrlConf();if(!t)return void(0===this.urlLoaderSet.size&&this.onError());const e=new k(t,this.freecdn);this.urlLoaderSet.add(e),e.onData=t=>{const s=e.bytesRead-this.bytesRead;s<=0||(this.bytesRead=e.bytesRead,s!==t.length&&(t=t.subarray(-s)),this.onData(t))},e.onEnd=()=>{if(!this.closed){this.closed=!0,this.onEnd();for(const t of this.urlLoaderSet)t!==e&&t.abort("TASK_DONE",!0)}},e.onError=s=>{console.warn("urlLoader.onError:",t.url,s.message),this.urlLoaderSet.delete(e),this.loadNextUrl()},e.onResponse=t=>{this.opened||(this.opened=!0,this.onOpen(t))},e.request(this)}}class q{constructor(t,e){this.freecdn=t,this.manifestUrl=e,this.urlWsMap=new Map,this.updating=!1,this.manifestHash=s,this.timer=0,this.interval=3e5,this.lastTime=0,this.noCache=!1,this.noCookie=!0}async update(){if(this.updating)return;const t=Date.now();if(!(t-this.lastTime<1e3)){this.lastTime=t,this.updating=!0;try{await this.reload()}catch{}this.updating=!1}}async reload(){const t=new Request(this.manifestUrl),e=await this.fetchManifest();if(e)return void await this.parseData(e,t);const s=await this.getCachedManifest(t);if(!s)return;const i=new g;if(await i.parse(s),!i.exist("/freecdn-manifest.txt"))return void console.warn("no fallback url");const n=new E;n.manifest=i;const a=await n.fetchBin("/freecdn-manifest.txt");await this.parseData(a,t,!0)}async fetchManifest(){const t=new AbortController,e=setTimeout((()=>{t.abort()}),3e3),s={signal:t.signal};this.noCookie&&(s.credentials="omit"),this.noCache&&(s.cache="reload");try{const t=await v(this.manifestUrl,s),i=await t.arrayBuffer();return new Uint8Array(i)}catch{console.warn("fetch manifest fail:",this.manifestUrl)}finally{clearTimeout(e)}}async getCachedManifest(t){try{const e=await this.freecdn.network.fetch(t,!0);return await e.text()}catch{}const e=await b.findCache(t);if(!e)return void console.error("no cached manifest");const s=await e.text();if(await this.verify(s))return s;console.error("invalid cached manifest")}async verify(t){const e=t.match(/^# SIGN: ([A-Za-z0-9+/=]{88})\n/);if(!e)return!1;const[s,i]=e,n=c.base64Decode(i),a=t.substr(s.length),r=c.utf8ToBytes(a);return await y.verify(r,n)}async parseData(t,e,s=!1){const i=await c.sha256(t);if(c.isArrayEqual(this.manifestHash,i))return;this.manifestHash=i;const n=c.bytesToUtf8(t);if(s&&!await this.verify(n))return void console.error("fallback manifest verify failed");const a=new Response(t);b.addCache(e,a);const r=new g;await r.parse(n),this.freecdn.manifest=r,this.applyConfs(r)}applyConfs(t){this.applyUpdateConf(t)}applyUpdateConf(t){const e=t.getFileParams("update");if(!e)return;const s=e.get("interval");if(s){const t=c.parseTime(s);isNaN(t)?console.warn("invalid update.interval:",s):this.setTimer(t)}else this.setTimer(3e5);const i=e.get("services");if(i){const t=i.split(" ");this.setServices(t)}"off"===e.get("cache")&&(this.noCache=!0);"on"==e.get("cookie")&&(this.noCookie=!1)}setTimer(t){this.interval!==t&&(this.interval,clearInterval(this.timer),t>0&&(this.timer=setInterval((()=>{this.update()}),t)))}setServices(t){for(const[e,s]of this.urlWsMap)t.includes(e)||(s.onerror=null,s.onclose=null,s.close(),this.urlWsMap.delete(e));for(const e of t)this.urlWsMap.has(e)||this.createWs(e)}createWs(t){const e=()=>{this.urlWsMap.delete(t),setTimeout((()=>{this.createWs(t)}),1e4)},s=new WebSocket(t);s.onmessage=t=>{const e=c.base64Decode(t.data);c.isArrayEqual(this.manifestHash,e)||this.update()},s.onclose=e,s.onerror=e,this.urlWsMap.set(t,s)}}class E{constructor(t){this.enableCacheStorage=!0,this.network=new j,this.inited=!1,t&&(this.updater=new q(this,t))}async fetch(t,e){const s=t instanceof Request&&!e?t:new Request(t,e);if(!this.manifest)return this.network.fetch(s);const i=this.manifest.get(s.url);if(!i)return this.network.fetch(s);const{urlConfs:n,params:a}=i.parse();let r=this.enableCacheStorage&&a.has("hash");if(r){const t=await b.findCache(s);if(t)return t}const o=new C(i.name,n,s,this);let c,l=!1;const p=()=>{const{desiredSize:t}=c;null!==t&&(t<=0?l||(o.pause(),l=!0):l&&(o.resume(),l=!1))},m=new ReadableStream({start(t){c=t},pull(){p()},cancel(t){console.warn("ReadableStream cancel:",t),o.abort(t)}}),[u,h,d]=function(){let t,e;return[new Promise(((s,i)=>{t=s,e=i})),t,e]}();return o.onData=t=>{c.enqueue(t),p()},o.onEnd=()=>{c.close()},o.onError=()=>{c.error(),d(),console.warn("fileLoader.onError:",s.url)},o.onOpen=t=>{const e=new Response(m,t);r&&b.addCache(s,e.clone()),h(e)},o.open(),u}async fetchText(t){return(await this.fetch(t)).text()}async fetchBin(t){const e=await this.fetch(t),s=await e.arrayBuffer();return new Uint8Array(s)}async fetchBlob(t){const e=await this.fetch(t),s=await e.arrayBuffer(),i=e.headers.get("content-type")||"";return new Blob([s],{type:i})}exist(t){return!!this.manifest&&this.manifest.exist(t)}async update(){this.updater&&await this.updater.update()}setPubKey(t){if(88===t.length){t="MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE"+t}return y.set(t)}async init(){this.inited||(this.inited=!0,r||(r=new w(".freecdn"),await r.open({cache:{keyPath:"url"},site:{keyPath:"site"}})),await b.init(),await this.update())}}var R;!function(e){const s=fetch,i=self;let n,a;let r=(t,e)=>{};async function c(t){if("GET"!==t.method)return s(t);a&&await a;const e=t.url,i=function(t){if("cors"===t.mode||t.integrity)return;const e=t.headers.get("accept")||"",s=t.url;return e.includes("image/avif")&&n.exist(s+".avif")?s+".avif":e.includes("image/webp")&&n.exist(s+".webp")?s+".webp":void 0}(t)||(o=e,n.exist(o)?o:o.endsWith("/")&&n.exist(o+"index.html")?o+"index.html":n.exist(o+"/index.html")?o+"/index.html":void 0);var o;if(!i)return s(t);i!==e&&(t=new Request(i,t));const c=await n.fetch(t);return r(c,e),c}function l(t,e,i){const n=t.request;if("only-if-cached"!==n.cache||"same-origin"===n.mode)if(/^https?:/.test(n.url))if(n.url!==location.href)c(n).then(e,i);else{e(new Response("/* freecdn is installed */",{headers:{"content-type":"text/javascript","cache-control":"max-age=99999"}}))}else s(n).then(e,i);else debugger}function p(t,e){const i=t instanceof Request&&!e?t:new Request(t,e);return/^https?:/.test(i.url)?c(i):s(i)}"onfetch"in i&&async function(){n=new E("/freecdn-manifest.txt");const e=i.FREECDN_SHARED_MODE;let s;e?(i.FREECDN_CACHE_STORAGE||(console.log("[freecdn] cache storage enabled"),n.enableCacheStorage=!1),a=o(),function(){t.func(i,"fetch",(t=>p)),t.func(Cache.prototype,"add",(t=>async function(t){const e=await p(t);await this.put(t,e)})),t.func(Cache.prototype,"addAll",(t=>async function(t){const e=t.map((t=>this.add(t)));await Promise.all(e)})),t.func(Response.prototype,"clone",(t=>function(){const s=e.get(this),i=t.call(this);return s&&e.set(i,s),i}));const e=new WeakMap;r=e.set.bind(e),t.prop(Response.prototype,"url",(t=>function(){return e.get(this)||t.call(this)}),null)}(),s=i.FREECDN_PUBKEY):s=i.P,s&&await n.setPubKey(s),await n.init(),e?(a?.resolve(),a=null):function(){const t=i.Q;for(t.push=l;t.length;){const e=t.splice(0,3);console.log("flush queue:",e[0].request.url),l(...e)}}(),console.log("[freecdn] service worker installed")}()}(R||(R={})),self.FreeCDN=E}();
//# sourceMappingURL=/freecdn-internal/freecdn-main.min.js.map
